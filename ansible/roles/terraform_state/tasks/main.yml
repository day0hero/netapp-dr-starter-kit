---
# terraform_state role (create-only)
#
# Ensures the S3 bucket and DynamoDB table used as the Terraform remote
# state backend exist.  This module uses local state and is fully idempotent:
# if the resources already exist in AWS (from a previous run, or created
# manually), it skips creation entirely.
#
# Destruction of the state backend is handled separately via
# "make destroy-terraform-state" to prevent accidental deletion.
#
# Expects:
#   terraform_state_bucket  - bucket name (from values-trident.yaml)
#   terraform_state_region  - AWS region to create the bucket in (prod region)

- name: Display terraform state backend configuration
  debug:
    msg:
      - "=========================================="
      - "Terraform State Backend"
      - "=========================================="
      - "Bucket:         {{ terraform_state_bucket }}"
      - "DynamoDB Table: {{ terraform_state_dynamodb_table }}"
      - "Region:         {{ terraform_state_region }}"
      - "=========================================="

- name: Validate bucket name is provided
  fail:
    msg: >
      terraform_state_bucket is required but empty.
      Set it in values-trident.yaml under .terraform.state.bucket
  when: terraform_state_bucket | default('') | trim == ''

# Get AWS credentials
- name: Get AWS credentials from boto3 session
  ansible.builtin.shell: |
    python3 -c "
    import json, boto3
    creds = boto3.Session().get_credentials().get_frozen_credentials()
    print(json.dumps({'ak': creds.access_key, 'sk': creds.secret_key, 'st': creds.token or ''}))
    "
  register: _boto3_creds
  changed_when: false

- name: Set AWS credentials
  set_fact:
    _aws_creds: "{{ _boto3_creds.stdout | from_json }}"
    _aws_env:
      AWS_ACCESS_KEY_ID: "{{ (_boto3_creds.stdout | from_json).ak }}"
      AWS_SECRET_ACCESS_KEY: "{{ (_boto3_creds.stdout | from_json).sk }}"
      AWS_SESSION_TOKEN: "{{ (_boto3_creds.stdout | from_json).st }}"
      AWS_REGION: "{{ terraform_state_region }}"
      AWS_DEFAULT_REGION: "{{ terraform_state_region }}"

# ---------------------------------------------------------------------------
# Check what already exists in AWS
# ---------------------------------------------------------------------------
- name: Check if S3 bucket already exists
  ansible.builtin.shell: >-
    aws s3api head-bucket --bucket {{ terraform_state_bucket }} 2>/dev/null
    && echo "exists" || echo "missing"
  register: _bucket_check
  changed_when: false
  environment: "{{ _aws_env }}"

- name: Check if DynamoDB table already exists
  ansible.builtin.shell: >-
    aws dynamodb describe-table
    --table-name {{ terraform_state_dynamodb_table }}
    --query 'Table.TableStatus' --output text 2>/dev/null
    || echo "missing"
  register: _dynamo_check
  changed_when: false
  environment: "{{ _aws_env }}"

- name: Set existence flags
  set_fact:
    _bucket_exists: "{{ 'exists' in _bucket_check.stdout }}"
    _dynamo_exists: "{{ _dynamo_check.stdout | trim in ['ACTIVE', 'CREATING'] }}"

- name: Display pre-check results
  debug:
    msg:
      - "S3 bucket '{{ terraform_state_bucket }}': {{ 'EXISTS' if _bucket_exists else 'MISSING - will create' }}"
      - "DynamoDB table '{{ terraform_state_dynamodb_table }}': {{ 'EXISTS' if _dynamo_exists else 'MISSING - will create' }}"

# ---------------------------------------------------------------------------
# If everything exists, skip terraform entirely (idempotent fast path)
# ---------------------------------------------------------------------------
- name: Skip terraform - state backend already exists
  debug:
    msg:
      - "=========================================="
      - "Terraform State Backend Ready (already exists)"
      - "=========================================="
      - "Bucket:   {{ terraform_state_bucket }}"
      - "DynamoDB: {{ terraform_state_dynamodb_table }}"
      - "Region:   {{ terraform_state_region }}"
      - "=========================================="
  when:
    - _bucket_exists
    - _dynamo_exists

# ---------------------------------------------------------------------------
# Create missing resources via AWS CLI (avoids Terraform provider API calls
# like DescribeTimeToLive that the IAM user may lack permissions for).
# ---------------------------------------------------------------------------
- name: Create S3 bucket
  when: not _bucket_exists
  block:
    - name: Create S3 bucket via AWS CLI
      ansible.builtin.shell: >-
        {% if terraform_state_region == 'us-east-1' %}
        aws s3api create-bucket
        --bucket {{ terraform_state_bucket }}
        --region {{ terraform_state_region }}
        {% else %}
        aws s3api create-bucket
        --bucket {{ terraform_state_bucket }}
        --region {{ terraform_state_region }}
        --create-bucket-configuration LocationConstraint={{ terraform_state_region }}
        {% endif %}
      environment: "{{ _aws_env }}"

    - name: Enable bucket versioning
      ansible.builtin.shell: >-
        aws s3api put-bucket-versioning
        --bucket {{ terraform_state_bucket }}
        --versioning-configuration Status=Enabled
        --region {{ terraform_state_region }}
      environment: "{{ _aws_env }}"

    - name: Enable server-side encryption
      ansible.builtin.shell: >-
        aws s3api put-bucket-encryption
        --bucket {{ terraform_state_bucket }}
        --server-side-encryption-configuration
        '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"},"BucketKeyEnabled":true}]}'
        --region {{ terraform_state_region }}
      environment: "{{ _aws_env }}"

    - name: Block public access
      ansible.builtin.shell: >-
        aws s3api put-public-access-block
        --bucket {{ terraform_state_bucket }}
        --public-access-block-configuration
        BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
        --region {{ terraform_state_region }}
      environment: "{{ _aws_env }}"

    - name: Configure lifecycle rule for old versions
      ansible.builtin.shell: >-
        aws s3api put-bucket-lifecycle-configuration
        --bucket {{ terraform_state_bucket }}
        --lifecycle-configuration
        '{"Rules":[{"ID":"cleanup-old-versions","Status":"Enabled","NoncurrentVersionExpiration":{"NoncurrentDays":90},"Filter":{"Prefix":""}}]}'
        --region {{ terraform_state_region }}
      environment: "{{ _aws_env }}"

    - name: S3 bucket created
      debug:
        msg: "S3 bucket '{{ terraform_state_bucket }}' created in {{ terraform_state_region }}"

- name: Create DynamoDB table
  when: not _dynamo_exists
  block:
    - name: Create DynamoDB lock table via AWS CLI
      ansible.builtin.shell: >-
        aws dynamodb create-table
        --table-name {{ terraform_state_dynamodb_table }}
        --attribute-definitions AttributeName=LockID,AttributeType=S
        --key-schema AttributeName=LockID,KeyType=HASH
        --billing-mode PAY_PER_REQUEST
        --tags Key=Name,Value={{ terraform_state_dynamodb_table }} Key=Purpose,Value="Terraform State Locking" Key=ManagedBy,Value=Ansible
        --region {{ terraform_state_region }}
      environment: "{{ _aws_env }}"

    - name: Wait for DynamoDB table to become active
      ansible.builtin.shell: >-
        aws dynamodb describe-table
        --table-name {{ terraform_state_dynamodb_table }}
        --query 'Table.TableStatus' --output text
        --region {{ terraform_state_region }}
      environment: "{{ _aws_env }}"
      register: _dynamo_status
      until: _dynamo_status.stdout | trim == 'ACTIVE'
      retries: 30
      delay: 2
      changed_when: false

    - name: DynamoDB table created
      debug:
        msg: "DynamoDB table '{{ terraform_state_dynamodb_table }}' is ACTIVE"

- name: Display state backend summary
  debug:
    msg:
      - "=========================================="
      - "Terraform State Backend Ready"
      - "=========================================="
      - "Bucket:   {{ terraform_state_bucket }}"
      - "Region:   {{ terraform_state_region }}"
      - "DynamoDB: {{ terraform_state_dynamodb_table }}"
      - "=========================================="
  when: not _bucket_exists or not _dynamo_exists
