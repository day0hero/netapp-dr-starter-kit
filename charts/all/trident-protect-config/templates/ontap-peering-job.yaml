{{- if .Values.tridentProtect.ontapPeering.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: ontap-peering-{{ .Release.Revision }}
  namespace: trident-protect
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: ontap-peering
          image: {{ .Values.tridentProtect.ontapPeering.image }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e

              ONTAP_USER=$(cat /credentials/username)
              ONTAP_PASS=$(cat /credentials/password)
              AUTH="${ONTAP_USER}:${ONTAP_PASS}"

              LOCAL_CLUSTER_MGMT="{{ .Values.tridentFSX.clusterLIF }}"
              LOCAL_SVM="{{ .Values.tridentFSX.svm }}"
              REMOTE_SVM="{{ .Values.tridentFSX.peer.svm }}"
              REMOTE_IC_IPS='{{ .Values.tridentFSX.peer.interclusterIPs | toJson }}'

              api() {
                curl -sk -u "${AUTH}" -H "Content-Type: application/json" "$@"
              }

              echo "============================================"
              echo "  ONTAP Cluster & SVM Peering (local side)"
              echo "============================================"
              echo "  Local cluster mgmt: ${LOCAL_CLUSTER_MGMT}"
              echo "  Local SVM:          ${LOCAL_SVM}"
              echo "  Remote SVM:         ${REMOTE_SVM}"
              echo "  Remote IC IPs:      ${REMOTE_IC_IPS}"
              echo "============================================"

              CLUSTER_PEERS_URL="https://${LOCAL_CLUSTER_MGMT}/api/cluster/peers?fields=status,name,uuid"
              SVM_PEERS_URL="https://${LOCAL_CLUSTER_MGMT}/api/svm/peers?fields=state,svm,peer"

              # ---- Step 1: Cluster Peering (local side only) ----
              echo ""
              echo "--- Checking cluster peering ---"
              PEERS=$(api "${CLUSTER_PEERS_URL}")
              PEER_COUNT=$(echo "${PEERS}" | jq '.num_records // 0')

              if [ "${PEER_COUNT}" -gt 0 ]; then
                echo "Cluster peering already exists (${PEER_COUNT} peer(s))."
              else
                PASSPHRASE="${ONTAP_PASS}"

                echo "Creating cluster peer on local FSx (${LOCAL_CLUSTER_MGMT})..."
                RESP=$(api -X POST "https://${LOCAL_CLUSTER_MGMT}/api/cluster/peers" \
                  -d "{\"remote\":{\"ip_addresses\":${REMOTE_IC_IPS}},\"authentication\":{\"passphrase\":\"${PASSPHRASE}\"}}" \
                  -w "\n%{http_code}" 2>/dev/null)
                HTTP=$(echo "${RESP}" | tail -1)
                BODY=$(echo "${RESP}" | sed '$d')
                echo "  HTTP ${HTTP}"
                if [ "${HTTP}" -ge 400 ]; then
                  echo "  Error: $(echo "${BODY}" | jq -r '.error.message // "unknown"')"
                fi

                echo "Waiting for peer cluster to configure its side..."
                sleep 15
              fi

              # ---- Step 2: Wait for peering to become available ----
              echo ""
              echo "--- Verifying cluster peering ---"
              echo "  (Peering completes once both clusters have configured their side)"
              RETRIES=0
              while [ ${RETRIES} -lt 30 ]; do
                PEERS=$(api "${CLUSTER_PEERS_URL}")
                PEER_COUNT=$(echo "${PEERS}" | jq '.num_records // 0')
                if [ "${PEER_COUNT}" -eq 0 ]; then
                  echo "  No peers yet (waiting for local creation to propagate...)"
                  RETRIES=$((RETRIES + 1))
                  sleep 10
                  continue
                fi
                PEER_STATE=$(echo "${PEERS}" | jq -r '.records[0].status.state // "unknown"')
                if [ "${PEER_STATE}" = "available" ]; then
                  break
                fi
                echo "  Peer state: ${PEER_STATE} (waiting for remote side...)"
                RETRIES=$((RETRIES + 1))
                sleep 10
              done

              PEER_UUID=$(echo "${PEERS}" | jq -r '.records[0].uuid // empty')
              PEER_NAME=$(echo "${PEERS}" | jq -r '.records[0].name // empty')
              PEER_STATE=$(echo "${PEERS}" | jq -r '.records[0].status.state // "unknown"')
              echo "  Cluster peer: ${PEER_NAME} (${PEER_UUID}) - state: ${PEER_STATE}"

              if [ -z "${PEER_UUID}" ]; then
                echo "ERROR: No cluster peer found."
                exit 1
              fi

              if [ "${PEER_STATE}" != "available" ]; then
                echo "WARNING: Cluster peer not yet available (state: ${PEER_STATE})."
                echo "  The remote cluster Job may not have run yet."
                echo "  SVM peering will be attempted on next sync."
                exit 0
              fi

              # ---- Step 3: SVM Peering ----
              echo ""
              echo "--- Checking SVM peering ---"
              SVM_PEERS=$(api "${SVM_PEERS_URL}")
              SVM_PEER_COUNT=$(echo "${SVM_PEERS}" | jq '.num_records // 0')

              if [ "${SVM_PEER_COUNT}" -gt 0 ]; then
                echo "SVM peering already exists (${SVM_PEER_COUNT} peer(s))."
              else
                echo "Creating SVM peer: ${LOCAL_SVM} <-> ${REMOTE_SVM}..."
                RESP=$(api -X POST "https://${LOCAL_CLUSTER_MGMT}/api/svm/peers" \
                  -d "{\"svm\":{\"name\":\"${LOCAL_SVM}\"},\"peer\":{\"cluster\":{\"uuid\":\"${PEER_UUID}\"},\"svm\":{\"name\":\"${REMOTE_SVM}\"}},\"applications\":[\"snapmirror\"]}" \
                  -w "\n%{http_code}" 2>/dev/null)
                HTTP=$(echo "${RESP}" | tail -1)
                BODY=$(echo "${RESP}" | sed '$d')
                echo "  HTTP ${HTTP}"
                if [ "${HTTP}" -ge 400 ]; then
                  echo "  Error: $(echo "${BODY}" | jq -r '.error.message // "unknown"')"
                fi

                echo "Waiting for SVM peering to establish..."
                sleep 10
              fi

              # ---- Step 4: Final Verification ----
              echo ""
              echo "============================================"
              echo "  Peering Status (local view)"
              echo "============================================"
              echo "Cluster peers:"
              api "${CLUSTER_PEERS_URL}" | \
                jq -r '.records[] | "  \(.name): \(.status.state)"'
              echo "SVM peers:"
              api "${SVM_PEERS_URL}" | \
                jq -r '.records[] | "  \(.svm.name) <-> \(.peer.svm.name): \(.state)"'
              echo "============================================"
              echo "  ONTAP peering (local side) complete"
              echo "============================================"
          volumeMounts:
            - name: ontap-creds
              mountPath: /credentials
              readOnly: true
      volumes:
        - name: ontap-creds
          secret:
            secretName: {{ .Values.tridentProtect.ontapPeering.secretName }}
{{- end }}
